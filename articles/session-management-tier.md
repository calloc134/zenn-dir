---
title: "SPA + API セッション管理 安全性 Tier表作ってみた！"
emoji: "🙆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# はじめに

こんにちは、calloc134 です。

皆さん、SPA で アプリケーションを作るとき、API との セッション管理にはどのような手法を利用していますか？

クッキー？それとも localStorage に JWT などを保存して利用？

今回は、SPA + API のセッション管理について、基礎を押さえた上で、安全性の Tier 表を考えてみましょう。

# セッション管理における 2 つのレイヤ

- 巷では、クッキーか JWT か、などの議論が行われる
- しかし、その議論は 対立軸を誤っている
- セッション管理には 2 つのレイヤが存在する
  - トークン文字列がどのような形式か
  - トークン文字列をどこに保存し どのように取り出して送信するか
- この 2 つのレイヤを分けて考えることが重要
- 1. トークン形式
  - A. handle 型トークン
    - API 側のデータベースに セッション情報を保存し
    - トークン文字列は そのセッション情報を一意に指し示す ID のみ
    - API 側は トークン文字列を受け取ると
    - データベースを参照し セッション情報を取得する
      - 例: セッション ID、ランダム文字列トークン
    - ただ一意に指し示すだけでいいので 、トークン文字列自体は 短く ランダムなもので良い
    - 利点
      - API 側 で セッション情報を管理できるため、セッションの失効が可能
      - API 側 で セッション情報を管理できるため、セッション情報が古くならない
    - 欠点
      - API 側 で セッション情報を管理するため、情報を保存するインフラコストが発生する
      - API 側 で セッション情報を管理するため、スケーラビリティが低下する可能性がある
      - API 側 で セッション情報を管理するため、DB アクセスが発生し レイテンシが増加する
  - B. assertion 型トークン
    - トークン文字列自体に セッション情報を含む
    - API 側は トークン文字列を受け取ると
    - トークン文字列を解析し セッション情報を取得する
      - 例: JWT
    - トークン文字列自体に セッション情報を含むため、トークン文字列は 長く 複雑になる
    - ほとんどの場合、暗号化や署名が施される
    - 利点
      - API 側 で セッション情報を管理しないため、インフラコストが発生しない
      - API 側 で セッション情報を管理しないため、スケーラビリティが向上する
      - API 側 で セッション情報を管理しないため、DB アクセスが発生せず レイテンシが低減する
    - 欠点
      - API 側 で セッション情報を管理しないため、セッションの失効が困難
      - API 側 で セッション情報を管理しないため、セッション情報が古くなる可能性がある
- 2. トークン保存場所・送信方法

  - α. httpOnly クッキー に保存し ブラウザが自動送信
    - ブラウザの提供するクッキー機能を利用
    - httpOnly 属性を付与することで JavaScript からのアクセスを防止
    - API へのリクエスト時に ブラウザが自動的にクッキーを送信
    - 古き良き セッション管理手法 といえる
    - 利点
      - 攻撃者によって ブラウザに 悪意のある JavaScript コードが送り込まれた場合でも
        - JavaScript から クッキーにアクセスできないため
        - セッション情報そのものが盗まれるリスクを低減できる
          - 捕捉: ただし 悪意ある JavaScript から
          - クッキーを付けて API にアクセスすることは可能なことに注意
          - あくまでも 永続的に セッション情報が盗まれるリスクを低減できる、という意味であり
          - 悪意ある JavaScript が ブラウザで動作している間は セッションが乗っ取られるリスクがあることに注意
          - httponly が付いていても 被害が拡大する例:
            - パスワード変更 API を呼び出し パスワードを変更される
          - このような アカウントアクセス拡大に繋がる API 呼び出しは、
          - 事前に パスワード再認証を要求するなどの 対策が必要
        -
    - 欠点
      - しっかり CSRF 対策を行う必要がある
        - 今回は API が JSON を受け取り JSON を返すことを前提としているため
        - ある程度 CSRF は難しいものと考察される
        - ただし CORS 設定や CSRF 対策 ヘッダ などを用いて CSRF 対策をぬかりなく行う必要がある
        - CSRF は 設定を誤らなければ 防げる攻撃であるため
        - 十分に注意して対策を行うこと
  - β. ブラウザの提供するストレージやメモリに保存し JavaScript でその都度 取り出して 送信
    - JavaScript を用いて ストレージやメモリに トークン文字列を保存し
    - API へのリクエスト時に JavaScript で トークン文字列を取り出し
    - API リクエストヘッダなどに トークン文字列を付与して 送信
    - 近年の SPA で よく利用される手法
    - トークンは以下のような場所に保存
      - ストレージ
        - localStorage
        - sessionStorage
        - IndexedDB
      - メモリ
        - React の state
        - JavaScript の変数
    - 利点
      - CSRF 対策が不要
        - JavaScript で API リクエストヘッダなどに トークン文字列を付与して 送信するため
        - 悪意ある第三者ドメインからの リクエストでは トークン文字列を付与できない
        - そのため CSRF 攻撃を防げる
    - 欠点
      - 攻撃者によって ブラウザに 悪意のある JavaScript コードが送り込まれた場合
        - その JavaScript から ストレージやメモリに保存された トークン文字列にアクセスできるため
        - 永続的に セッション情報が盗まれるリスクがある
        - この手法では トークン文字列の保存・取り出しを JavaScript が担うため
        - 悪意ある JavaScript の実行による トークン奪取問題を 根本的に防ぐことはできない
        - そのため、対処療法ではあるが
        - 悪意ある JavaScript の実行を防ぐ対策が重要
  - 非推奨: httponly でないクッキー
    - クッキーの利点が活かせない上に
    - JavaScript からアクセス可能であるため β の手法と同様の欠点を持つ
    - そのため、今回はこれを最初から非推奨とする

- 一般的には 上記の通り
- なお、2 つのトークンを組み合わせて利用することで、お互いの欠点を補うことも可能
  - 短命 assertion 型トークン + 長命 handle 型トークン
    - assertion 型トークンを 短命に設定し
    - 長命の handle 型トークンで assertion 型トークンを再発行する
    - 同時に 新しい 長命 handle 型トークンを発行し、古いものを無効化する
    - このように設計することで、assertion 型と handle 型の利点を組み合わせることが可能
      - assertion 型 トークンの欠点:
        - セッションの失効が困難
          - assertion 型トークンを 短命に設定することで
          - 短命 assertion 型 トークンが 盗まれた場合でも 短期間で無効化され 悪用が困難
          - また 長命 handle 型トークンは 失効可能であるため
          - 長命 handle 型トークンが 盗まれた場合でも
          - API 側で 失効させることで セッションを無効化可能
      - handle 型 トークンの欠点:
        - インフラコストが発生・スケーラビリティが低下・レイテンシが増加
          - セッションとしては 頻繁にアクセスする 短命 assertion 型トークンを利用することで
          - 普段のアクセスにおける DB アクセスを低減し インフラコストを抑制・スケーラビリティを向上・レイテンシを低減
          - 長命 handle 型トークンは 短命 assertion 型トークンの再発行時にのみ利用されるため
          - 頻繁にアクセスされることがなく インフラコストを抑制可能
          -

## セッション管理の安全性 Tier 表

- 上記の 2 つのレイヤを組み合わせた場合の 安全性 Tier 表
- なお、簡単に比較できないものも存在する
  - ハッセ図 という概念を利用し、安全性の高低を表現
  - 高低差を 単純に比較できないものは、枝分かれで表現する

# おわりに

今回は、SPA + API のセッション管理について、安全性の Tier 表を考えてみました。
安全な手法を取るに越したことはありませんが、安全性を高めるほど、利便性やインフラコストとのトレードオフが発生します。
自分のアプリケーションにとって、どの程度の安全性が必要かを見極め、適切なセッション管理手法を選択しましょう。

読んでいただき、ありがとうございました。
