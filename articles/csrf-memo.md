---
title: "SPA + API 環境におけるCSRF対策メモ"
emoji: "📌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

CSRF攻撃対策について、以下のメモを作成しています。
完全別ドメインでのCSRFの対策です。これについてファクトチェックしてください。
また、サブドメイン・同一ドメインの場合のCSRF対策についても同等に説明してください。

# 別ドメイン SPA + JSONAPI の場合のCSRF対策

原則

- 副作用あるなしの分離
- APIにはクッキーを含めて送信する必要がある
- クッキー
  - SameSite=None
  - HttpOnly
  - Secure
- 別ドメイン
  - 別オリジン
  - 別サイト
- CORS
  - credentials include
  - フロントエンド オリジンのみ許可

- JSONAPIによるCSRF 副作用あり
  - Origin検証 (API側)
    - Origin ヘッダは 別ドメインの場合は 別オリジンなので
    - 基本送信される
  - CORSポリシーにオリジンが含まれるか (ブラウザ側)
    - プリフライトリクエストで送信をブロック
    - 処理の流れ
      - 1. ブラウザがプリフライトリクエストを送信
      - 2. サーバーがCORSポリシーを含むレスポンスを返す
      - 3. ブラウザがレスポンスを確認し CORSポリシーにオリジンが含まれるかをチェック
      - 4. オリジンが含まれない場合 送信をブロック
  - CORSポリシーのオリジンが`*` の場合 credentials include でないか (ブラウザ側)
    - `*` と credentials include が両立する場合 送信をブロック
    - 処理の流れ
      - 1. ブラウザがプリフライトリクエストを送信
      - 2. サーバーがCORSポリシーを含むレスポンスを返す
      - 3. ブラウザがレスポンスを確認し オリジンが`*` かつ credentials include であるかをチェック
      - 4. 両立する場合 送信をブロック
- JSONAPI によるCSRF 副作用なし
  - Origin検証 (API側)
    - Origin ヘッダは 別ドメインの場合は 別オリジンなので
    - 基本送信される
    - JSONAPI によるCSRF 副作用ありの場合と同じ
  - CORSポリシーにオリジンが含まれるか (ブラウザ側)
    - そもそもの疎通をブロック
    - 処理の流れ
      - 1. ブラウザがリクエストを送信
      - 2. サーバーがCORSポリシーを含むレスポンスを返す
      - 3. ブラウザがレスポンスを確認し CORSポリシーにオリジンが含まれるかをチェック
      - 4. オリジンが含まれない場合 レスポンスがアプリケーションに渡されず 疎通をブロック
  - CORSポリシーのオリジンが`*` の場合 credentials include でないか (ブラウザ側)
    - `*` と credentials include が両立する場合 疎通をブロック
    - 処理の流れ
      - 1. ブラウザがリクエストを送信
      - 2. サーバーがCORSポリシーを含むレスポンスを返す
      - 3. ブラウザがレスポンスを確認し オリジンが`*` かつ credentials include であるかをチェック
      - 4. 両立する場合 レスポンスがアプリケーションに渡されず 疎通をブロック
- フォームによるCSRF 副作用あり
  - Origin検証 (API側)
    - Origin ヘッダは 別ドメインの場合は送信される
    - JSONAPIによるCSRF 副作用ありの場合と同じ
  - application/json 以外のContent-Type の拒否 (API側)
    - フォーム送信は application/x-www-form-urlencoded または multipart/form-data になる
  - 余談: CORSポリシーは関係ない
    - simple requestとして扱われるため
    - ブラウザはCORSポリシーをフォーム送信には適用しない
    - プリフライトリクエストも発生せず送信もブロックされない
  - 余談: credentials include は関係ない
    - このパラメータは fetch API や XMLHttpRequest に関するものであり
    - フォーム送信には影響しない
    - ブラウザはフォーム送信時にクッキーを自動的に含める

# サブドメイン SPA + JSONAPI の場合のCSRF対策

- 基本的には 別ドメイン と同じ対策を行う
- 同一サイトとなったため クッキーに変更を加える
- クッキー
  - SameSite=Lax

- JSONAPIによるCSRF 副作用あり
  - Origin検証 (API側)
    - Origin ヘッダは サブドメインの場合は 別オリジンなので
    - 基本送信される
  - CORSポリシーにオリジンが含まれるか (ブラウザ側)
    - プリフライトリクエストで送信をブロック
    - 処理の流れ
      - 1. ブラウザがプリフライトリクエストを送信
      - 2. サーバーがCORSポリシーを含むレスポンスを返す
      - 3. ブラウザがレスポンスを確認し CORSポリシーにオリジンが含まれるかをチェック
      - 4. オリジンが含まれない場合 送信をブロック
  - CORSポリシーのオリジンが`*` の場合 credentials include でないか (ブラウザ側)
    - `*` と credentials include が両立する場合 送信をブロック
    - 処理の流れ
      - 1. ブラウザがプリフライトリクエストを送信
      - 2. サーバーがCORSポリシーを含むレスポンスを返す
      - 3. ブラウザがレスポンスを確認し オリジンが`*` かつ credentials include であるかをチェック
      - 4. 両立する場合 送信をブロック
- JSONAPI によるCSRF 副作用なし
  - Origin検証 (API側)
    - Origin ヘッダは サブドメインの 場合は 別オリジンなので
    - 基本送信される
    - JSONAPI によるCSRF 副作用ありの場合と同じ
  - CORSポリシーにオリジンが含まれるか (ブラウザ側)
    - そもそもの疎通をブロック
    - 処理の流れ
      - 1. ブラウザがリクエストを送信
      - 2. サーバーがCORSポリシーを含むレスポンスを返す
      - 3. ブラウザがレスポンスを確認し CORSポリシーにオリジンが含まれるかをチェック
      - 4. オリジンが含まれない場合 レスポンスがアプリケーションに渡されず 疎通をブロック
  - CORSポリシーのオリジンが`*` の場合 credentials include でないか (ブラウザ側)
    - `*` と credentials include が両立する場合 疎通をブロック
    - 処理の流れ
      - 1. ブラウザがリクエストを送信
      - 2. サーバーがCORSポリシーを含むレスポンスを返す
      - 3. ブラウザがレスポンスを確認し オリジンが`*` かつ credentials include であるかをチェック
      - 4. 両立する場合 レスポンスがアプリケーションに渡されず 疎通をブロック
- フォームによるCSRF 副作用あり
  - SameSite=Lax により クッキーは送信されないため
  - 特に対策は不要
  - ただし多重防御を考えるのであれば 以下を追加してもよい
    - Origin検証 (API側)
      - Origin ヘッダは サブドメインの場合は 別オリジンなので
      - 基本送信される
    - application/json 以外のContent-Type の拒否 (API側)
      - フォーム送信は application/x-www-form-urlencoded または multipart/form-data になる

(ここに内容を記述)

# 同一ドメイン SPA + JSONAPI の場合のCSRF対策

- 基本的には サブドメイン と同じ対策を行う
- 同一オリジンとなったため 該当箇所に変更を加える
- クッキー
  - SameSite=Lax
- JSONAPI によるCSRF 副作用あり
  - CORS ポリシーがなく厳密に管理されているため
  - 特に対策は不要
  - ただし多重防御を考えるのであれば 以下を追加してもよい
    - Origin検証
      - Origin ヘッダは 同一ドメインの場合は同一オリジンだが
      - unsafe methods (POST, PUT, DELETE など) の場合は基本送信される
- JSONAPI によるCSRF 副作用なし
  - CORS ポリシーがなく厳密に管理されているため
  - 特に対策は不要
  - Origin ヘッダは 同一ドメインの場合は同一オリジンであり
    - さらに safe methods (GET, HEAD, OPTIONS など) の場合は基本送信されない
    - そのため検証は不要
- フォームによるCSRF 副作用あり
  - SameSite=Lax により クッキーは送信されないため
  - 特に対策は不要
  - ただし多重防御を考えるのであれば 以下を追加してもよい
    - Origin検証 (API側)
      - Origin ヘッダは 同一ドメインの場合は基本送信される
    - application/json 以外のContent-Type の拒否 (API側)
      - フォーム送信は application/x-www-form-urlencoded または multipart/form-data になる
  -
