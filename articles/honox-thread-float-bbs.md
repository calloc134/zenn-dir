---
title: "最新技術スタックで伝統掲示板を再構築: HonoXでスレッドフロート型掲示板を作った話"
emoji: "📋"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["hono", "honox", "Bun", "個人開発"]
published: false
---

みなさんこんにちは。calloc134 です。今回も面白いものを作ったので是非宣伝させてください。
日本のインターネット文化を形作った 2 ちゃんねるスタイルの掲示板を、令和最新の技術スタックで再構築してみました。

今回は、そんな掲示板「VakKarma」について解説していきます。

https://github.com/calloc134/vakkarma-main

# はじめに

## スレッドフロート型掲示板とは

スレッドフロート型掲示板は、2 ちゃんねるや 5 ちゃんねるなどでおなじみの掲示板スタイルです。
新しい投稿（レス）が付いたスレッドが、自動的に掲示板の一覧の最上位に浮上（フロート）する仕組みを持つ電子掲示板です。

> スレッドフロート型掲示板（スレッドフロートがたけいじばん）とは、最新のコメント投稿がなされたスレッドがその掲示板のスレッド群の最上位に表示される機能を持つ電子掲示板を指す。フローティングスレッド型掲示板とも言う。
> (https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%AC%E3%83%83%E3%83%89%E3%83%95%E3%83%AD%E3%83%BC%E3%83%88%E5%9E%8B%E6%8E%B2%E7%A4%BA%E6%9D%BF)

この方式は 1998 年に日本で初めて「multi2」というスクリプトで実装され、その後「あめぞう」を経て「2 ちゃんねる」へと発展しました。現在では 5 ちゃんねる、4chan、8chan など世界中の多くの匿名掲示板で採用されている形式です。
活発な議論が行われているスレッドが常に上位に表示されるため、ユーザーは掲示板の「今」を瞬時に把握できるというメリットがあります。

## VakKarma とは

VakKarma は、「ゼロちゃんねるプラス」をベースにした 2 ちゃんねる風スレッドフロート型掲示板の現代的再実装です。

「ゼロちゃんねるプラス」は、2 ちゃんねる互換のスレッドフロート型掲示板スクリプトとして開発されたものの一つです。インターネット上の多くの 2 ちゃんねる系掲示板の運営に利用されてきました。

> 『ぜろちゃんねるプラス』は２ちゃんねる互換スレッドフロート型掲示板スクリプトの『ぜろちゃんねる』をより２ちゃんねるに近いものにするとともに、よりよい機能を追加していき、ぜろちゃんねるの上位版として提供していくプロジェクトです。
> https://ja.osdn.net/projects/zerochplus/releases/77053

VakKarma は、このゼロちゃんねるプラスの UI を参考にしつつ、最新の Web 開発技術で再構築されています。伝統的な 2 ちゃんねる風の UI ながら、現代のブラウザやデバイスで快適に利用できるように設計されています。

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/screenshot1.png)

# 使い方

VakKarma は、Cloudflare Workers 上でも動作します。デモをすでにデプロイしているので、ぜひ試してみてください。

https://vakkarma-main.calloc134personal.workers.dev/

読み込みが遅い問題については、[Neon Database](https://neon.tech/)の無料枠を利用しており、日本リージョンがないことが理由であると考えています。ご了承ください。

## トップページ

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/screenshot3.png)

上位のスレッド 30 件が表示されます。スレッドのタイトルをクリックすると、スレッドの詳細ページに遷移します。また、上位 10 件のスレッドは、スレッドの最初のレス・最新のレスが表示されます。

表示されているスレッドに対しては、レスを行うことができます。また、「全部読む」リンクよりスレッドの詳細ページに遷移することができます。

ページの下部には、新規スレッド作成のためのフォームが存在します。

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/screenshot4.png)

## スレッド詳細ページ

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/screenshot5.png)

スレッドの詳細ページでは、スレッドのタイトルとスレッドの全てのレスが表示されます。また、レスの投稿フォームも存在します。

## 管理画面

掲示板の管理画面では、掲示板の各種設定を操作することができます。

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/screenshot6.png)

`/admin` にアクセスした後、ログインを求められます。パスワード認証に成功した後、管理画面に遷移します。

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/screenshot7.png)

管理画面では、掲示板の各種設定を操作することができます。掲示板名やローカルルール、名無しの場合のデフォルト名、スレッドやレスの最大文字数などを設定できます。

パスワードの変更もここで行うことができます。

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/screenshot8.png)

## 専用ブラウザ (ChMate) からの接続

ChMate などの専用ブラウザからの接続もサポートしています。

vakkarma の URL の末尾に`/senbura/`を追加することで、専用ブラウザからの接続が可能になります。例えば先程のデモサイトであれば、`https://vakkarma-main.calloc134personal.workers.dev/senbura/`となります。

この URL を ChMate に登録することで、専用ブラウザからの接続が可能になります。

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/senbura1.png)
![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/senbura2.png)

閲覧だけでなく、レスの投稿やスレッドの作成も可能です。

## レスポンシブ対応

スマホやタブレットでも快適に利用できるよう、レスポンシブデザインが実装されています。画面サイズに応じて、表示内容が最適化されます。

![vakkarma](https://raw.githubusercontent.com/calloc134/vakkarma-main/main/readme/screenshot2.png)

## クライアント JavaScript 不要

VakKarma は、クライアントサイドの JavaScript を使用せずとも十分に利用することができます。この仕様により、Tor ブラウザなどをはじめとする JavaScript を無効にした環境でも動作します。

## その他仕様

![](/images/honox-thread-float-bbs/2025-04-04-16-54-43.png)

スレッド作成・レス作成時はどちらもコンテンツの入力が必須です。 ユーザ名は任意ですが、名無しの場合は管理者画面で設定した名前が表示されます。

ユーザ名に`#`を含めることで、`#`以降の文字列がトリップとして表示されます。
トリップ生成の仕組みは本家とは異なりますが、より安全に生成されるように設計されています。また、データベースには生成された後のトリップが保存されるため、万が一データベースが漏洩した場合でも、トリップの元データは漏洩しないように設計されています。

https://ja.wikipedia.org/wiki/%E3%83%88%E3%83%AA%E3%83%83%E3%83%97_(%E9%9B%BB%E5%AD%90%E6%8E%B2%E7%A4%BA%E6%9D%BF)

また、ID については IP アドレスと日時から一意に生成されるものを使用しています。

# 特徴

## コアとなる技術スタック

VakKarma の コアとなる技術スタックは以下の通りです。

- HonoX
- SafeQL

型安全性を重視した設計がなされており、開発者は安心してコードを書くことができます。

### HonoX による型安全な UI 構築

VakKarma では 、HonoX と呼ばれるメタフレームワークを使用しています。

https://github.com/honojs/honox

https://zenn.dev/yusukebe/articles/4d6297f3be121a
https://zenn.dev/yusukebe/articles/724940fa3f2450

HonoX は軽量高速な Web フレームワーク Hono をベースとしたメタフレームワークです。開発環境を Vite で提供することにより、サーバサイドアプリケーションの開発にモダンフロントエンドのような開発体験を導入している点が大きな強みです。

HonoX では、JSX により HTML 要素を型安全に記述できる点が大きな特徴です。
従来のテンプレートエンジンでは、html の記述を行う際に単なる文字列として扱われるため、型情報を失ってしまいます。これにより、HTML の構築時に型エラーが発生する可能性があります。また、HTML の構築時に IDE の補完機能が働かないため、開発体験が損なわれてしまいます。
しかし、HonoX ではコントローラーから直接 JSX を返却できるため、型情報を保持したまま HTML を構築でき、React で開発しているかのような開発体験の良さを実現しています。
また、コンポーネントのような再利用可能な UI 部品を作成することも可能です。これにより、開発者はコードの再利用性を高めることができ、保守性の向上にも寄与します。

![](/images/honox-thread-float-bbs/2025-04-04-16-24-27.png)

これにより、開発者は型安全なコードを記述でき、バグの発生を防ぐことができます。

また、HonoX は Hono の上に構築されているため、Hono 向けに提供されているミドルウェアやプラグインをそのまま利用することができます。これにより、開発者は Hono のエコシステムを活用しながら、型安全な開発を行うことができます。

![](/images/honox-thread-float-bbs/2025-04-04-16-28-46.png)

HonoX は開発の途中ではありますが、すでに多くの機能が実装されており、バグも少なく安定しています。HonoX の開発は活発に行われており、今後の機能追加や改善が期待されます。

### SafeQL による型安全なデータベース操作

データベースアクセスには、PostgreSQL と型安全な SQL クエリを実現する SafeQL が使用されています。SafeQL は、ESLint プラグインとしてクエリの型チェックを行い、実行前にエラーを検出します。

![](/images/honox-thread-float-bbs/2025-04-04-16-32-04.png)

SafeQL の主な特徴は以下の通りです。

1. クエリのミススペルや構文エラーを検出
2. 型の不一致（文字列と数値の比較など）を警告
3. クエリの結果に対する正確な型推論と型注釈の提案

これにより、複雑なクエリも型安全に記述でき、開発者は安心してデータベース操作を行うことができます。なお、ESLint プラグインとして提供されているため、本番環境には影響を与えません。

SafeQL の詳細や、ORM・クエリビルダとの比較については以前の記事で詳しく解説しています。参考にしてください。

https://zenn.dev/calloc134/articles/4a8c1af0eb5aae

## VakKarma をサポートする技術スタック

その他、VakKarma を支える技術スタックは以下の通りです。

### Tailwind CSS によるスタイリングとレスポンシブデザイン

2 ちゃんねる風のシンプルなデザインながら、スマートフォンからデスクトップまで様々な画面サイズに対応するレスポンシブデザインが実装されています。これには Tailwind CSS が使用されています。

Tailwind は「ユーティリティファースト」の CSS フレームワークです。複雑な CSS ファイルを作成せずに直接 HTML にクラスを適用する方法で、効率的にスタイリングを行えます。

![](/images/honox-thread-float-bbs/2025-04-04-16-33-38.png)

### 開発環境・本番環境の双方をサポートする Docker

本番環境・開発環境の双方に、Docker が積極的に採用されています。Docker Compose を利用することで、PostgreSQL データベースやその他の必要なサービスを含む完全な開発・本番環境を簡単に構築できます。

開発環境ではデータベースとマイグレーションのみ提供されますが、開発者は Vite を利用してアプリケーションを開発できます。ホットリロード機能によりサーバサイドのコードを変更した場合でもブラウザが自動的に更新され、開発がスムーズに行えます。

本番環境では、データベースとマイグレーションに加え、アプリケーションコンテナとリバースプロキシも提供されます。

アプリケーションコンテナの JavaScript ランタイムとして Node.js の代わりに Bun を採用しています。Bun は起動が高速でメモリ使用量が少なく、パフォーマンスが向上する利点があります。

![](/images/honox-thread-float-bbs/2025-04-04-16-41-50.png)

また、リバースプロキシとして Traefik を採用しており、そのままでも十分に運用可能な環境が整っています。

https://traefik.io/traefik/

### HonoX のサポートによるデプロイの選択肢の広がり

VakKarma は HonoX を使用しているため、デプロイ環境の選択肢が広がります。
現時点では Bun にデプロイする選択肢の他、Cloudflare Workers にデプロイすることが可能です。前述のデモサイトは、Cloudflare Workers 上にデプロイされています。

![](/images/honox-thread-float-bbs/2025-04-04-17-44-44.png)

### ESLint によるコード品質の向上

VakKarma では ESLint を使用してコードの品質を保っています。特に、TypeScript の型チェックやコードスタイルの統一に役立ちます。
ESLint v9 からデフォルトとなった Flat Config で記述されています。以下のルールが有効となっています。

- SafeQL
- 命名規則の統一
- 不要な import の削除
- import 順序の統一

### Github Actions による CI/CD

GitHub Actions を利用して CI/CD を実現しています。プルリクエストが作成されると、テストが自動的に実行され、問題がないことを確認できます。
また、Cloudflare Workers のデモ環境へのデプロイも自動化されています。

![](/images/honox-thread-float-bbs/2025-04-04-17-45-29.png)

## ドメイン駆動設計

VakKarma は、ドメイン駆動設計を意識して開発されています。
表現したいロジックについて、ドメインロジックをしっかり満たせるような設計がなされています。

### ディレクトリ構造

![](/images/honox-thread-float-bbs/2025-04-04-18-28-10.png)

集約単位に分割し、それぞれ

- ドメイン層
- ユースケース層
- リポジトリ層

と分割して実装しています。厳密に何かのアーキテクチャに沿っているという訳ではありませんが、原則は十分に満たせていると思います。

### 実装の原則

今回の実装では、エラーハンドリングを行うために`neverthrow`を導入し、`Result`型を使用しています。これは、成功時と失敗時の両方の結果を表現するための型です。戻り値に`Result`型を使用することで、明示的なエラーハンドリングが可能になり、コードの可読性と保守性が向上します。

https://github.com/supermacro/neverthrow

### ドメイン層

ドメイン層では、ドメインオブジェクトを定義し、ビジネスロジックを実装しています。
`read/`ディレクトリ以下には、内部から外部に返却する読み取り用の型を定義しています。これに対し、`write/`ディレクトリ以下には、外部から受取り内部に書き込みを行うための型を定義しています。
特性上、ドメインロジックが複雑なモデルは`write/`以下に記述されます。

具体的なコードを見てみましょう。

![](/images/honox-thread-float-bbs/2025-04-04-18-20-30.png)

このコードだけでも、メールの形式のような制約がドメインオブジェクトにしっかりと実装されていることがわかります。

値オブジェクトは、それぞれ Tagged Union (Discriminated Union) を使用して実装しています。これにより、同じプロパティを持つオブジェクトを混同することなく、別の型として扱うことができます。これにより、誤った値オブジェクトを利用してしまうことを防ぎます。
Tagged Union については、以下のリンクを参考にしてください。

https://typescriptbook.jp/reference/values-types-variables/discriminated-union

ドメインモデリングにあたり、データベースの値を参照する必要のある制約が出てくる場合は、高階関数パターンを採用しています。高階関数の内部でデータベースにアクセスすることをユーザに期待するような形で実装しています。これにより、データベースへのアクセスをドメインロジックから分離することができます。

https://zenn.dev/loglass/articles/2e0fdbf5b0f7a9
![](/images/honox-thread-float-bbs/2025-04-04-18-15-46.png)

### ユースケース層

ユースケース層では、ドメインオブジェクトを操作するためのユースケースを定義します。
ユースケースの関数は、生の値を受け取りエンティティや値オブジェクトを生成したり、リポジトリに永続化したりする役割を持っています。永続化レイヤやドメインロジックを意識せず、十分に抽象化されたコードとなることが望ましいです。

https://github.com/calloc134/vakkarma-main/blob/main/src/conversation/usecases/postResponseByThreadIdUsecase.ts

### リポジトリ層

リポジトリ層ではデータベースへのアクセスを行ないます。内部では sql タグを用いたクエリを使用しています。これにより、SQL クエリを TypeScript の型安全なコードとして記述することができます。

https://github.com/calloc134/vakkarma-main/blob/main/src/conversation/repositories/getAllThreadsRepository.ts

引数や戻り値は値オブジェクトとなるため、外界から不適切なデータを受け付けることはありません。

### ハンドラ層？

明記はしていませんが、HonoX のコントローラがハンドラ層に相当します。リクエストを受け取り、ユースケースを呼び出す役割を持っています。簡易的なリクエストバリデーションを行い、戻り値に沿ってレスポンスを返却します。
ユースケースの戻り値に`Result`型を使用しているため、明示的なエラーハンドリングが可能です。

# 今後の展望

VakKarma は現在も開発中であり、今後の機能追加や改善を検討しています。以下は今後の展望です。

アプリケーション機能

- 閲覧するレスの範囲を指定できるパラメータの追加
- NG ワード登録機能の追加
- レス検索機能の追加
- captcha の導入
- スレッドの削除・ロック機能の追加
- レスの削除機能の追加

副次的な機能

- env をセットアップできる対話型スクリプトの追加
- テストの追加
- ログ出力の追加
- セルフホスト時の https 化のサポート
- セルフホスト時の Hidden Service (\*.onion) 化のサポート
- Cloudfare Tunnel での公開のサポート
- その他、要望に応じた機能の追加

# まとめ

HonoX を利用し、以前から作りたかったスレッドフロート型掲示板を作成することができました。HonoX は本当に開発体験が良く、型安全なコードを書くことができるため、開発が楽しかったです。
個人的にも納得のいく完成度のものが出来たと思います。これからも開発を続けていきたいと思いますので、ぜひご期待ください。

もし興味があれば、GitHub リポジトリを覗いてみてください。スターを付けていただけると嬉しいです。今後の開発の励みになります。

https://github.com/calloc134/vakkarma-main

https://vakkarma-main.calloc134personal.workers.dev/
