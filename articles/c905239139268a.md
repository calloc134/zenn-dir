---
title: "WaniCTF2023 ゆるく出た - writeup"
emoji: "🚩"
type: "tech" # tech: 技術記事 / idea: 🚩アイデア
topics: ["CTF"]
published: true
---

こんにちは。calloc134です。
前回のRicercaCTFに引き続き、WaniCTF2023にも参加しました。
開始すぐに参加して、二時間くらいで四問解きました。
そのあとはweb以外にもトライしようと思ったのですが、気が抜けてしまい放置してしまいました…
とりあえず解けた問題を共有します。

![](/images/Wani_result.png)

## IndexedDB

まず以下のような画面が表示されます。

![](/images/Wani_result1.png)

任意のパスを指定するとリダイレクトされますが、このリダイレクトはJavascriptにて行っており、リダイレクト前のレスポンスにフラグが存在します。
![](/images/index2.png)

## Extract Service 1 & Extract Service 2

まず以下のような画面が表示されます。

![](/images/c905239139268a/2023-05-18-19-06-53.png)

任意のファイルをアップロードすると、以下のようなエラーが表示されます。
![](/images/c905239139268a/2023-05-18-19-08-08.png)

ここで、docxファイルの中身がzipファイルであるということを念頭に置きます。
そして、内部の処理ではzipファイルを展開して
`word/document.xml`を読み込んでいることがわかります。

ここでは、zipファイルにシンボリックリンクを埋め込み、`word/document.xml`にフラグへのシンボリックリンクを配置することで、フラグを読み取ることができます。

このzipファイルの作成にはWSLを利用しました。

以下のようなディレクトリ構成でzipを作成します。

```
./
├── word
    └── document.xml (これが/flagへのシンボリックリンク)
```
![](/images/c905239139268a/2023-05-18-19-12-32.png)

その後、以下のコマンドで、シンボリックリンクを含んだzipファイルを作成します。

```
zip -ry TARGET.zip word/
```

![](/images/c905239139268a/2023-05-18-19-14-42.png)

これをアップロードしてフラグを読み取ります。

![](/images/c905239139268a/2023-05-18-19-15-35.png)

同じ手法で、Extract Service 2も解くことができます。

![](/images/c905239139268a/2023-05-18-19-16-18.png)

## Certified 1

まず以下のような画面が表示されます。

![](/images/c905239139268a/2023-05-18-19-17-24.png)

エラーより、バックエンドでImageMagickを利用していることがわかります。

![](/images/c905239139268a/2023-05-18-19-18-42.png)

ここで、ImageMagickのLFIの脆弱性を探しました。
最終的に、CVE-2022-44268で攻撃が通りました。

利用したPoCは以下のものです。
https://github.com/Sybil-Scan/imagemagick-lfi-poc

以下のコマンドで、エクスプロイト画像を生成します。

```
python3 generate.py -f "/flag_A" -o exploit.png
```

このようにエクスプロイト画像を生成します。
![](/images/c905239139268a/2023-05-18-19-21-38.png)

アップロードすると以下のような画像が生成されます。
![](/images/c905239139268a/2023-05-18-19-22-58.png)

これをwgetでダウンロードした後、ファイルを解析します。

以下のコマンドを利用します。

```
identify -verbose (output).png
```

![](/images/c905239139268a/2023-05-18-19-25-27.png)

Raw profile typeに付属している16進数の値をデコードすると、フラグが得られます。

```
 python3 -c 'print(bytes.fromhex("464c41477b3768655f736563306e645f663161395f31735f77343174316e395f6630725f793075217d0a").decode("utf-8"))'
 ```

 ![](/images/c905239139268a/2023-05-18-19-28-31.png)

 ## おわりに

以上でWaniCTF2023のwriteupを終わります。

初心者でしたが、なかなか楽しく解けました。

他のwriteupも色々読んでいて、気が付かされるものばかりでした。
今後も、積極的にCTFに参加していきたいと思います。