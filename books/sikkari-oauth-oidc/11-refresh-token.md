---
title: "リフレッシュトークン"
---

# リフレッシュトークンとは

これまでの章で、アクセストークンを取得するフローについて解説してきました。

しかし、アクセストークンには**有効期限**があります。セキュリティの観点から、アクセストークンの有効期限は短く設定されることが一般的です。

では、アクセストークンの有効期限が切れたらどうするのでしょうか？

毎回ユーザに認可フローをやり直してもらうのは、ユーザ体験として好ましくありません。

そこで登場するのが、**リフレッシュトークン**です。

# リフレッシュトークンの役割

リフレッシュトークンは、**新しいアクセストークンを取得するためのトークン**です。

アクセストークンの有効期限が切れた場合、リフレッシュトークンを使って新しいアクセストークンを取得できます。

これにより、ユーザは再度認可フローを行うことなく、継続してリソースにアクセスできます。

# アクセストークンとリフレッシュトークンの違い

| 項目           | アクセストークン                   | リフレッシュトークン               |
| -------------- | ---------------------------------- | ---------------------------------- |
| 用途           | リソースサーバへのアクセス         | 新しいアクセストークンの取得       |
| 有効期限       | 短い（数分〜数時間）               | 長い（数日〜数ヶ月）               |
| 送信先         | リソースサーバ                     | 認可サーバ                         |
| 漏洩時のリスク | リソースへの不正アクセス（期限内） | 長期間にわたるアクセストークン取得 |

# リフレッシュトークンフロー

リフレッシュトークンを使ってアクセストークンを取得するフローは以下の通りです。

```mermaid
sequenceDiagram
    participant クライアント
    participant 認可サーバ

    クライアント->>クライアント: アクセストークンの有効期限が切れた
    クライアント->>認可サーバ: リフレッシュトークンを使って<br>新しいアクセストークンをください
    認可サーバ->>認可サーバ: リフレッシュトークンを検証
    認可サーバ->>認可サーバ: 新しいアクセストークンを発行
    認可サーバ->>クライアント: 新しいアクセストークン<br>(+ 新しいリフレッシュトークン)
```

1. クライアントがリソースサーバにアクセスしようとするが、アクセストークンの有効期限が切れている
2. クライアントは保持しているリフレッシュトークンを使って、認可サーバに新しいアクセストークンを要求する
3. 認可サーバはリフレッシュトークンを検証し、有効であれば新しいアクセストークンを発行する
4. 認可サーバはクライアントに新しいアクセストークンを返す（新しいリフレッシュトークンも返すことがある）

# リフレッシュトークンリクエスト

リフレッシュトークンを使ってアクセストークンを取得する際のリクエスト例です。

```http
POST /oauth2/token HTTP/1.1
Host: auth.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&refresh_token=tGzv3JOkF0XG5Qx2TlKWIA
&scope=read write
```

## パラメータの説明

| パラメータ名  | 説明                                                    |
| ------------- | ------------------------------------------------------- |
| grant_type    | `refresh_token`（リフレッシュトークンを使うことを示す） |
| refresh_token | リフレッシュトークン                                    |
| scope         | リソースへのアクセス範囲（省略可能）                    |

Confidential Client の場合、通常のトークンリクエストと同様にクライアント認証が必要です。

# リフレッシュトークンレスポンス

```http
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8

{
    "access_token": "SlAV32hkKG",
    "token_type": "Bearer",
    "expires_in": 3600,
    "refresh_token": "dQw4w9WgXcQ",
    "scope": "read write"
}
```

新しいリフレッシュトークンが発行される場合もあります。その場合、古いリフレッシュトークンは無効になることが一般的です。

# リフレッシュトークンのセキュリティ

リフレッシュトークンは長期間有効であるため、漏洩した場合のリスクが高いです。

## セキュリティ対策

### 1. リフレッシュトークンローテーション

リフレッシュトークンを使用するたびに、新しいリフレッシュトークンを発行し、古いリフレッシュトークンを無効にする方式です。

これにより、リフレッシュトークンが漏洩しても、一度使用されると無効になります。

### 2. リフレッシュトークンの失効

ユーザがログアウトした場合や、不正利用が検出された場合に、リフレッシュトークンを失効させる機能を実装します。

### 3. Confidential Client でのみ発行

Public Client の場合、リフレッシュトークンの安全な保管が難しいため、リフレッシュトークンを発行しない選択肢もあります。

# まとめ

- **リフレッシュトークン**は、新しいアクセストークンを取得するためのトークン
- アクセストークンの有効期限が切れても、ユーザの操作なしで新しいアクセストークンを取得できる
- リフレッシュトークンは長期間有効であるため、セキュリティに注意が必要
- **リフレッシュトークンローテーション**などの対策により、漏洩時のリスクを軽減できる
