---
title: "アクセストークンの形式"
---

# アクセストークンの形式

「アクセストークンって、JWT 形式になってて、アクセストークンを解読すれば色々な情報が見れるようになってるんだよね？」といった理解の方もいらっしゃるかもしれません。

しかし、OAuth の RFC では、**アクセストークンの形式を特に規定していません**。

> トークンは認可情報を取り出すための識別子を表したり, 検証可能な方法でそれ自身に認可情報を含んでもよい (データと署名を含むトークン文字列など). クライアントがトークンを使用するために, 本仕様で定めていない追加の認証クレデンシャルを要求することもできる^[https://openid-foundation-japan.github.io/rfc6749.ja.html#anchor8].

つまり、JWT のようにアクセストークンに認可情報を含めることもできますし、ランダムな文字列であっても構いません。

# Handle と Assertion

OAuth2.0 に関連し、脅威モデルとセキュリティについて解説している RFC である RFC6819 には、アクセストークンの形式を以下のように分類しています^[https://openid-foundation-japan.github.io/rfc6819.ja.html#section_tokens]。

| トークンの形式 | 別名            | 特徴                                                                                           |
| -------------- | --------------- | ---------------------------------------------------------------------------------------------- |
| Handle         | Opaque トークン | ランダム文字列からなるトークンであり、認可サーバ内部のデータを参照するキーとして使用されるもの |
| Assertion      | JWT など        | 解析可能なトークンであり、電子署名を持ち、内部に情報を含むもの                                 |

> "handle" ("artifact" とも呼ばれる) とは, 認可サーバー内部のデータ構造に対するある種の参照である
> assertion とはパース可能なトークンである. assertion は典型的には有効期間, 発行対象 (audience) を持ち, 改竄防止および発行者認証のため電子署名が付けられる.

![](/images/5e8da6c491e720/2024-09-26-19-52-37.png)

# それぞれの特性

## Handle（Opaque トークン）

Handle 型のトークンは、ランダムな文字列であり、認可サーバ内部のデータを参照するポインタとして使用されます。

**メリット**

- トークンの情報が古くなることがない（常に最新のデータを参照できる）
- トークンの失効が容易（データベースから削除すればよい）

**デメリット**

- 認可サーバとリソースサーバが分離している場合、リソースサーバが認可サーバに問い合わせる必要があるため、通信コストがかかる

Handle 型トークンを採用する場合は、リソースサーバがアクセストークンの詳細を知る目的で、認可サーバに問い合わせるための API が必要です。これは**イントロスペクション API** と呼ばれ、RFC7662 で定義されています^[https://tex2e.github.io/rfc-translater/html/rfc7662.html]。

## Assertion（JWT など）

Assertion 型のトークンは、情報をもたせることができ、発行者認証やデータの埋め込みが可能です。

**メリット**

- わざわざ認可サーバに問い合わせる必要がないため、扱いやすくて便利
- 有効期限や発行者認証ができるため、セキュリティ的にも有利

**デメリット**

- 情報が変更されたときに、その変更をリアルタイムに反映することが難しい
- トークンの失効は非常に難しい（トークン自体に情報が含まれているため）

Assertion 型トークンは扱いやすいですが、データが古くなりやすく、失効の実装が大変です。失効という実装自体を完全に諦め、利便性の保てる範囲内でアクセストークンの期限を出来るだけ短くすることで対処を行うというのが現実的な着地点であると言えるでしょう。

# まとめ

OAuth 自体はアクセストークンの形式については特に規定していないため、どちらを使うかは実装者の自由ということを覚えておきましょう。

| 形式      | 特徴                       | 適したケース                             |
| --------- | -------------------------- | ---------------------------------------- |
| Handle    | ランダム文字列、常に最新   | 失効が頻繁に必要、認可サーバと同一サーバ |
| Assertion | 情報を含む、問い合わせ不要 | 分散システム、パフォーマンス重視         |

:::message
この議論を見ていると、セッション（ステートフル）と JWT（ステートレス）の対立の議論と本質的に同じような気がしますね・・・。
:::

参考リンク
https://openid-foundation-japan.github.io/rfc6819.ja.html#section_tokens
https://qiita.com/TakahikoKawasaki/items/970548727761f9e02bcd
https://kiririmode.hatenablog.jp/entry/20170205/1486287614
