---
title: "リフレッシュトークンとそのフロー"
---

# リフレッシュトークンとそのフロー

この章では、**リフレッシュトークン**について解説します。

## リフレッシュトークンとは

**リフレッシュトークン**は、アクセストークンを再発行するためのトークンです。

アクセストークンには有効期限があり、期限が切れるとリソースにアクセスできなくなります。このとき、ユーザに再度認可フローを行わせるのは UX の観点から望ましくありません。

リフレッシュトークンを使うことで、ユーザの操作なしにアクセストークンを更新できます。

## アクセストークンとリフレッシュトークンの比較

| 項目               | アクセストークン           | リフレッシュトークン         |
| ------------------ | -------------------------- | ---------------------------- |
| **用途**           | リソースサーバへのアクセス | アクセストークンの再発行     |
| **有効期限**       | 短い（数分〜数時間）       | 長い（数日〜数ヶ月）         |
| **送信先**         | リソースサーバ             | 認可サーバ                   |
| **漏洩時のリスク** | リソースへの不正アクセス   | 新しいアクセストークンの発行 |

## なぜ有効期限を分けるのか

「リフレッシュトークンの有効期限が長いなら、最初からアクセストークンの有効期限を長くすればいいのでは？」と思うかもしれません。

しかし、これはセキュリティ上の理由から避けるべきです：

1. **アクセストークンは頻繁に送信される**

   - リソースへのアクセスのたびに送信される
   - 漏洩のリスクが高い

2. **リフレッシュトークンは限られた場面でのみ送信される**

   - 認可サーバへの送信のみ
   - 漏洩のリスクが低い

3. **有効期限を分けることでリスクを軽減**
   - アクセストークンが漏洩しても、短い有効期限で被害を限定
   - リフレッシュトークンは安全な通信でのみ使用

## リフレッシュトークンフロー

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant AS as 認可サーバ
    participant RS as リソースサーバ

    Note over Client,RS: アクセストークンが期限切れ
    Client->>RS: ①アクセストークンでリクエスト
    RS->>Client: ②エラー：トークン期限切れ
    Client->>AS: ③リフレッシュトークンで新しいアクセストークンをリクエスト
    AS->>AS: リフレッシュトークン検証
    AS->>AS: 新しいアクセストークン発行
    AS->>Client: ④新しいアクセストークン（+ 新しいリフレッシュトークン）
    Client->>RS: ⑤新しいアクセストークンでリクエスト
    RS->>Client: ⑥リソースを返却
```

### リフレッシュトークンリクエスト

```http
POST /oauth2/token HTTP/1.1
Host: authorization-server.example.com
Authorization: Basic Y2xpZW50X2lkOmNsaWVudF9zZWNyZXQ=
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&refresh_token=REFRESH_TOKEN
```

| パラメータ      | 説明                                                |
| --------------- | --------------------------------------------------- |
| `grant_type`    | `refresh_token`（リフレッシュトークンフローを示す） |
| `refresh_token` | リフレッシュトークン                                |

Confidential Client の場合、クライアント認証も必要です。

### リフレッシュトークンレスポンス

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
    "access_token": "NEW_ACCESS_TOKEN",
    "token_type": "Bearer",
    "expires_in": 3600,
    "refresh_token": "NEW_REFRESH_TOKEN",
    "scope": "photos.read"
}
```

新しいアクセストークンとともに、新しいリフレッシュトークンが発行されることがあります。

## リフレッシュトークンのセキュリティ

リフレッシュトークンは長期間有効であるため、適切な管理が必要です。

### リフレッシュトークンローテーション

認可サーバは、リフレッシュトークンを使用するたびに新しいリフレッシュトークンを発行し、古いものを無効化することがあります（**リフレッシュトークンローテーション**）。

これにより：

- 漏洩したリフレッシュトークンの再利用を検知できる
- 攻撃者が使用した場合、正規ユーザのトークンが無効化される

### 保管場所の重要性

リフレッシュトークンは、アクセストークン以上に安全に保管する必要があります。

- **Confidential Client**：サーバサイドで安全に保管
- **Public Client**：セキュアストレージに保管（ブラウザの場合は特に注意）

## まとめ

- **リフレッシュトークン**は、アクセストークンを再発行するためのトークン
- アクセストークンより**有効期限が長い**
- ユーザの操作なしにアクセストークンを更新できる
- **リフレッシュトークンローテーション**により、セキュリティを向上できる
- 長期間有効であるため、**安全な保管が重要**

次の章では、クライアントの種類（Confidential Client と Public Client）の違いについて詳しく解説します。
