---
title: "リフレッシュトークンとそのフロー"
---

## 概要

この章では、リフレッシュトークンの概念とそのフローについて解説します。

## リフレッシュトークンとは

**リフレッシュトークン**は、アクセストークンを再発行するためのトークンです。

RFC 6749 では、以下のように説明されています。

> リフレッシュトークンは, アクセストークンを取得するために使用されるクレデンシャルである. リフレッシュトークンは認可サーバーによってクライアントに対して発行され, 現在のアクセストークンが無効化されたり期限が切れた場合に, 新しいアクセストークンを取得するために使用される
>
> — [RFC 6749 Section 1.5](https://www.rfc-editor.org/rfc/rfc6749#section-1.5)

## なぜリフレッシュトークンが必要か

アクセストークンの有効期限を短くすることは、セキュリティ上望ましいです。

- 漏洩した場合の被害を最小限に抑えられる
- Assertion 式トークンの場合、即時失効が難しいため有効期限で対処

しかし、有効期限が短いと、ユーザは頻繁に再認可を行う必要があります。

そこで、リフレッシュトークンを使って以下を実現します。

- **アクセストークン**：有効期限は短い（例：1 時間）
- **リフレッシュトークン**：有効期限は長い（例：30 日）
- アクセストークンが期限切れになったら、リフレッシュトークンを使って新しいアクセストークンを取得

これにより、ユーザは頻繁に再認可を行う必要がなく、かつセキュリティも確保できます。

## リフレッシュトークンの取得

リフレッシュトークンは、トークンレスポンスに含まれます（認可サーバの設定による）。

```json
{
  "access_token": "2YotnFZFEjr1zCsicMWpAA",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "tGzv3JOkF0XG5Qx2TlKWIA",
  "scope": "read write"
}
```

## リフレッシュトークンを使ったアクセストークンの再取得

```mermaid
sequenceDiagram
    participant C as クライアント
    participant AS as 認可サーバ

    C->>AS: リフレッシュリクエスト
    Note right of C: grant_type=refresh_token<br>refresh_token=xxx<br>+ クライアント認証
    AS->>AS: クライアント認証
    AS->>AS: リフレッシュトークンを検証
    AS->>AS: 新しいアクセストークンを発行
    AS->>C: 新しいアクセストークン<br>(+新しいリフレッシュトークン)
```

### リフレッシュリクエスト

```http
POST /oauth2/token HTTP/1.1
Host: authorization-server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token
&refresh_token=tGzv3JOkF0XG5Qx2TlKWIA
```

| パラメータ      | 説明                                        |
| --------------- | ------------------------------------------- |
| `grant_type`    | `refresh_token`（リフレッシュフローを示す） |
| `refresh_token` | リフレッシュトークン                        |

Confidential Client の場合、クライアント認証も必要です。

### リフレッシュレスポンス

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "access_token": "new_access_token",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "new_refresh_token",
  "scope": "read write"
}
```

新しいアクセストークンとともに、新しいリフレッシュトークンが返されることもあります（認可サーバの実装による）。

## リフレッシュトークンのセキュリティ

リフレッシュトークンはアクセストークンよりも長命であるため、以下の点に注意が必要です。

### 1. 安全な保管

リフレッシュトークンは、アクセストークン以上に安全に保管する必要があります。

### 2. リフレッシュトークンローテーション

リフレッシュトークンを使うたびに、新しいリフレッシュトークンを発行し、古いリフレッシュトークンを無効化する方式です。

- 万が一リフレッシュトークンが漏洩しても、被害を最小限に抑えられる
- 攻撃者が使用すると、正規ユーザのリフレッシュトークンも無効化される

### 3. スコープの制限

リフレッシュ時に、元のスコープと同じかそれ以下のスコープのみを要求できるようにする。

## まとめ

- **リフレッシュトークン**はアクセストークンを再発行するためのトークン
- アクセストークンの有効期限を短く保ちつつ、ユーザの利便性を確保できる
- リフレッシュトークンは長命なため、セキュリティに注意が必要
