---
title: "OIDCと必要な概念"
---

## 概要

この章では、**OpenID Connect（OIDC）** の立ち位置および
OIDC を理解するために必要な概念の整理を行います。

OAuth 2.0 編で学んだ知識を踏まえ、
OIDC がどのように OAuth 2.0 を拡張しているのかを見ていきましょう。

## OAuth 2.0 と OIDC の関係性（復習）

前章までで学んだ通り、OAuth 2.0 は**認可**のためのフレームワークです。
一方、OIDC は **OAuth 2.0 の上に載るアイデンティティレイヤー** として定義されています。

> OpenID Connect 1.0 is a simple identity layer on top of the OAuth 2.0 protocol.
>
> — [OpenID Connect Core 1.0](https://openid.net/specs/openid-connect-core-1_0.html)

両者の目的は異なりますが、技術的には密接に繋がっています。

| 項目     | OAuth 2.0                | OIDC                             |
| -------- | ------------------------ | -------------------------------- |
| 目的     | リソース認可             | ID 連携                          |
| 発行物   | アクセストークン         | ID トークン (+ アクセストークン) |
| 主な用途 | リソースへのアクセス制御 | 外部の認証結果を用いたログイン   |

OIDC は OAuth 2.0 を拡張した仕様であるため、
OAuth 2.0 で解説した攻撃手法の多くが OIDC にも当てはまります。

## ID トークンの解説

### ID トークンとは

**ID トークン** は、ユーザーの**認証結果の証明書**としてのトークンです。

OAuth 2.0 の認可コードフローではアクセストークンを用いてリソースにアクセスしましたが、
OIDC ではそれに加えて ID トークンが発行されます。
ID トークンには**認証されたユーザーに関する情報（クレーム）** が含まれます。

### OIDC における ID トークンの役割

OIDC では、以下のような流れでユーザー認証が行われます。
なお、ここで登場する RP は Relying Party の略で、
OAuth における**クライアントに相当**します。
詳細は次章で解説します。

1. **Relying Party（RP）** が ID トークンを受け取る
2. RP が ID トークンを **検証** する
3. 検証に成功 → ユーザーを認証する

ここで重要なのは、OIDC の目的が **ユーザー認証** であるという点です。
ID トークンは、そのための検証材料として使われます。

### ID トークンと JWT

ID トークンには **JWT（JSON Web Token）** の仕様が使われています。
JWT の詳細な仕様については、次章以降で解説します。

## アクセストークンと ID トークンの違い

OAuth 2.0 のアクセストークンと OIDC の ID トークンは、
似ているようで目的が大きく異なります。
これらのトークンの違いを整理しておきましょう。

### アクセストークン

| 項目           | 内容                                   |
| -------------- | -------------------------------------- |
| 目的           | リソースへのアクセス、認可             |
| 現実の例え     | 鍵（漏洩すると即座に危険）             |
| 検証主体       | リソースサーバー                       |
| 運用           | クライアントが保持し続ける             |
| ライフサイクル | 必要に応じてリフレッシュトークンで更新 |

アクセストークンは「鍵」のようなものです。
この鍵があればリソースにアクセスできてしまうため、
漏洩には細心の注意が必要です。

クライアントはアクセストークンを保持しますが、
アクセストークンを検証するのはリソースサーバーです。

また、クライアントはアクセストークンを一定期間保持し、
必要に応じてリフレッシュトークンで新しいアクセストークンを取得・更新します。

### ID トークン

| 項目           | 内容                                   |
| -------------- | -------------------------------------- |
| 目的           | ID 連携                                |
| 現実の例え     | 証明書（認証結果の証明）               |
| 検証主体       | Relying Party（RP）                    |
| 運用           | 検証してセッション開始後は破棄してよい |
| ライフサイクル | セッション開始のための一時的な検証材料 |

ID トークンは「証明書」のようなものです。

ID トークンを検証するのは Relying Party（RP）であり、
長期間の保持は不要です。
ユーザーが確かに認証されたことを検証し、セッションを開始したら、
**ID トークンは破棄する** ことができます。

:::message

一部のログアウト仕様との関係から、
ID トークンを破棄しないようにする実装も存在します。

:::

### 比較表

| 観点     | アクセストークン     | ID トークン          |
| -------- | -------------------- | -------------------- |
| 目的     | リソースアクセス     | ユーザー認証         |
| 検証主体 | リソースサーバー     | Relying Party        |
| 保持期間 | 長期（リフレッシュ） | 短期（検証後は不要） |

## まとめ

- **OIDC は OAuth 2.0 の上に載る仕様**
  - OAuth 2.0 がリソース認可、OIDC が ID 連携を目的とする
- **OIDC の目的はユーザー認証**
  - ID トークンを検証してユーザーを認証する
- **ID トークンは JWT 仕様に基づく署名付きトークン**
  - JWT の詳細は次章以降で解説
- **アクセストークンと ID トークンは検証の主体や運用が異なる**
  - アクセストークン → リソースサーバーが検証、継続的に保持
  - ID トークン → RP が検証、検証後は破棄可能
