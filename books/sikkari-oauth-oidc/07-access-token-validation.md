---
title: "アクセストークンの検証手順"
free: true
---

## 概要

この章では、リソースサーバがアクセストークンを受け取った際、
アクセストークンをどのように検証するかについて解説します。

前章ではアクセストークンの形式（Handle 式 / Assertion 式）について解説しました。
リソースサーバはアクセストークンを受け取った際に、そのトークンが正当なものであるかを検証する必要があります。

OAuth 2.0 ではアクセストークンの形式が定義されていないため、
同様にアクセストークンの具体的な検証手順も定義されていません。

しかし、代表的な形式である Handle 式と Assertion 式については、
それぞれ一般的な検証手順が存在します。
この章では、できるだけ一般的な検証手順を解説します。

## 両者に共通する検証手順

リソースサーバがアクセストークンを受け取った際、
以下の検証手順を踏む必要があります。

1. アクセストークンの有効性検証
2. メタデータの取得と検証

これらについて、順番に解説します。

### アクセストークンの有効性検証

有効性の検証では、以下の点を確認します。

- 該当する アクセストークンが正当に発行されたものであるか
- アクセストークンが有効期限内であるか

この二点を確認することで、アクセストークンが不正に発行されたものでないこと、
および期限切れでないことを確認できます。

### 検証に必要なメタデータ

有効性の検証が終わると、次にメタデータの検証を行います。
検証において必要なメタデータはおおよそ次の通りです。

| メタデータ            | 説明                                          |
| --------------------- | --------------------------------------------- |
| **発行者 (issuer)**   | アクセストークン を発行した認可サーバの識別子 |
| **受信者 (audience)** | アクセストークン の受信者を示す識別子         |
| **スコープ (scope)**  | アクセストークン に紐づくスコープ情報         |

#### 発行者 (issuer)

アクセストークンを発行した認可サーバの識別子です。
リソースサーバは、アクセストークンに含まれる発行者が
自分が信頼する認可サーバのものであることを確認します。

#### 受信者 (audience)

アクセストークンの受信者、つまりアクセストークンがアクセスを許可するリソースサーバの識別子です。
リソースサーバは、この識別子が自分自身の識別子と一致することを検証します。

アクセストークンは、受信者を複数含むことができます。
例えば、一つのアクセストークンで複数のリソースサーバにアクセスできる場合などです。

このとき、受信者が配列の形で表現されることがあります。
複数の受信者が含まれる場合、リソースサーバは自分自身の受信者識別子がそのリストの中に含まれていることを確認します。

#### スコープ (scope)

アクセストークンに紐づくスコープ情報です。
リソースサーバは、アクセストークンに含まれるスコープが
要求されたリソースへのアクセスのスコープを満たしていることを確認します。

スコープの検証はアプリケーションの実装に依存するため、
具体的な方法はここでは解説しません。

### 検証手順の注意点

OAuth 2.0 では、トークン検証、特に Handle 式の検証において、
明確な手順が定義されていません。
したがって、アクセストークン検証の具体的な方法は実装に依存します。

ここでは、コミュニティの多くの実装を踏まえた一般的な流れを解説します。

## Handle 式アクセストークンの検証

Handle 式 アクセストークン を利用する場合、そのままだとランダムな文字列（opaque）であり、
リソースサーバはトークンの内容を直接確認できません。

そこでリソースサーバは認可サーバに問い合わせを行い、アクセストークンの情報を取得する必要があります。
これを行うため、認可サーバが アクセストークンの情報を提供するための API を提供します。

### Token Introspection エンドポイント

OAuth 2.0 Token Introspection エンドポイントは、
[RFC 7662](https://www.rfc-editor.org/rfc/rfc7662) で定義されています。

リソースサーバはこのエンドポイントに対してアクセストークンの情報を問い合わせ、
その情報を元にトークンの有効性とメタデータを検証します。

### アクセストークンの有効性検証

アクセストークンの有効性検証では、以下の点を確認します。

- アクセストークン が正当に発行されたかどうか
- アクセストークン が有効期限内かどうか

これらの情報は、認可サーバが検証を行い返答します。
Introspection API のレスポンスには `active` フィールドが含まれており、
このフィールドが `true` であれば、アクセストークン は有効であると判断できます。

したがって、Handle 式の 有効性検証では、
リソースサーバ側で特別な検証を行う必要はありません。
リソースサーバは Introspection API に問い合わせを行い、
レスポンスの `active` フィールドが `true` であれば有効と判断するだけです。

### メタデータの検証

Introspection API のレスポンスには、検証に関連する以下のフィールドが含まれます。

| フィールド | 説明                       |
| ---------- | -------------------------- |
| `iss`      | 発行者 (issuer)            |
| `aud`      | 受信者 (audience)          |
| `scope`    | スコープ (scope)           |
| `exp`      | 有効期限 (expiration time) |

検証の手順は、[本章「検証に必要なメタデータ」節](#検証に必要なメタデータ) で解説した通りです。

:::message
有効期限（`exp`）については、有効期限内であれば `active` が `true` になるため、
`exp` を個別に検証する必要はないことが多いです。
キャッシュが関連する場合は `exp` を検証するケースがありますが、今回は割愛します。
:::

### Introspection API のレスポンスについて

一般的に、Introspection API のレスポンスには、
JWT に含まれるフィールドと同様のフィールドが含まれます。

しかし、仕様では `active` フィールド以外のフィールドは必須ではありません。
したがって、認可サーバの実装によってはフィールドが不足している場合があります。

## Assertion 式アクセストークンの検証

Assertion 式 アクセストークン は、リソースサーバがトークンの内容を直接検証できます。
代表的な形式として JWT 形式のアクセストークンがあります。

JWT 形式の アクセストークン 仕様は
[RFC 9068](https://www.rfc-editor.org/rfc/rfc9068) で定義されています。

:::message

JWT の詳細仕様については OIDC 章で解説していますが、ここでは簡単に解説します。
より詳細な内容については OIDC 章を参照してください。

:::

JWT 形式の アクセストークンは、署名付きのトークンであり、
データを内部に含むことが出来ます。
アクセストークンの検証は、JWT の検証手順に従って行います。

### アクセストークンの有効性検証

JWT 形式の アクセストークン の有効性検証では、以下の点を確認します。

- アクセストークン が正当に発行されているかどうか（署名検証）
- `typ` ヘッダーが `at+jwt` であること
- アクセストークン が有効期限内かどうか（`exp` クレーム）

JWT の署名検証では、認可サーバの公開鍵を使用して署名を検証します。
具体的な署名検証の流れは OIDC 章の JWT 仕様解説を参照してください。

また、`typ`ヘッダや`exp`クレームの検証も JWT の標準的な検証手順に従うものです。

### メタデータの検証

次に、メタデータの検証を行います。
JWT 形式の アクセストークン には、以下のフィールドが含まれます。

| フィールド | 説明              |
| ---------- | ----------------- |
| `iss`      | 発行者 (issuer)   |
| `aud`      | 受信者 (audience) |
| `scope`    | スコープ (scope)  |

この検証の手順も、[本章「検証に必要なメタデータ」節](#検証に必要なメタデータ) で解説した通りです。

## まとめ

リソースサーバはアクセストークンを受け取った際に、その有効性とメタデータを検証する必要があります。

検証手順はアクセストークンの形式によって異なる場合がありますが、おおよそ手順は共通しています。

### アクセストークンの有効性検証

- 該当するアクセストークンが正当に発行されたものであるか
- アクセストークンが有効期限内であるか

### メタデータの取得と検証

- 発行者 (issuer)
- 受信者 (audience)
- スコープ (scope)

代表的な形式として、Handle 式と Assertion 式があります。
それぞれの形式に応じた検証手順を理解し、適切に実装することが重要です。
