---
title: "JWT（JWS形式）の詳しい構造"
free: true
---

## 概要

[前章](/calloc134/books/sikkari-oauth-oidc/viewer/24-jwt-jws-jwe-overview)で説明した **JWS Compact Serialization 形式の JWT** について、詳しい構造を解説します。
この形式は OIDC の ID トークンで使用されるため、しっかり理解しておきましょう。

## JWS 形式 JWT の構造

JWS 形式の JWT は
**ペイロード部分に任意の JSON オブジェクトを含める** ことができます。
この特性により、ユーザ情報などの任意のデータを
署名により整合性保護された形でやり取りできます。

:::message
なお仕様の定義では、
この任意の JSON オブジェクトとは **クレーム** を格納するものであるとされています。

クレームとは**ある主体に関して主張される情報**のことであり、
ある主体（例：ユーザや認証結果など）に関する情報を表現します。

そして、JWT が含める JSON オブジェクトは
JWT 仕様の定めるクレームの集合体であるため、
**JWT Claims Set** と呼ばれます。

つまり、ある主体の属性を表現するクレームを
JWT Claims Set として JSON オブジェクトにまとめ、
これをペイロード部分に含めることで、
その主体に関する情報を JWS 形式の JWT として表現できるということです。
:::

:::message

本来の JWS 仕様では、ペイロード部分は任意のデータを含められます。
ペイロードに JSON オブジェクトを含めるよう規定しているのは JWT 仕様に由来します。
:::

## 構成要素

JWS Compact Serialization 形式の JWT は、
以下の **3 つの部分** で構成されます。

```
ヘッダ部分.ペイロード部分.署名部分
```

それぞれの部分が **Base64Url エンコード** され、**ピリオド（.）** で連結されます。

```
Base64Url(ヘッダ).Base64Url(ペイロード).Base64Url(署名)
```

### ヘッダ部分（JOSE Header）

ヘッダ部分は **JOSE Header** とも呼ばれ、
署名アルゴリズムなどの **メタデータ** を含みます。

```json
{
  "alg": "RS256",
  "typ": "JWT"
}
```

代表的なパラメータは以下の通りです。

| パラメータ | 説明             | 必須/任意 |
| ---------- | ---------------- | --------- |
| `alg`      | 署名アルゴリズム | **必須**  |
| `typ`      | トークンの種類   | 任意      |
| `kid`      | 鍵識別子         | 任意      |

`alg`は 使用する署名アルゴリズムを指定するパラメータであり、 **必須** です。
`typ` や `kid` については OIDC ID トークンの章で詳しく解説します。

ヘッダの JSON を Base64Url エンコードしたものが、JWT の最初の部分になります。

### ペイロード部分（JWT Claims Set）

ペイロード部分には、**任意のデータ** を含めることができます。
JWT では、ペイロードに含まれる JSON 形式のデータを
クレームの集合として **JWT Claims Set** と呼びます。

```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "iat": 1516239022
}
```

JWT の仕様（RFC 7519）では、以下の **登録済みクレーム**（Registered Claims）が定義されています。[^rfc7519-claims]

| クレーム | 名称            | 説明                                  |
| -------- | --------------- | ------------------------------------- |
| `iss`    | Issuer          | JWT の発行者                          |
| `sub`    | Subject         | JWT の主題（ユーザ識別子など）        |
| `aud`    | Audience        | JWT の受信者                          |
| `exp`    | Expiration Time | JWT の有効期限（Unix タイムスタンプ） |
| `nbf`    | Not Before      | JWT が有効になる日時                  |
| `iat`    | Issued At       | JWT の発行日時                        |
| `jti`    | JWT ID          | JWT の一意識別子                      |

[^rfc7519-claims]: RFC 7519 Section 4.1 において、JWT の登録済みクレーム（iss, sub, aud, exp, nbf, iat, jti）が定義されています。https://www.rfc-editor.org/rfc/rfc7519.html#section-4.1

パラメータの中で必須なものは存在しませんが、
もしパラメータが含まれる場合は
**特定の意図を持って使用されるべきパラメータ** です。

このうち ID トークンで利用されるパラメータについては
次章で詳しく解説します。

ペイロードの JSON を Base64Url エンコードしたものが
JWT の 2 番目の部分になります。

### 署名部分

署名部分には、生成した **署名または MAC 値** が含まれます。

署名対象のデータは ヘッダを Base64Url エンコードしたものと
ペイロードを Base64Url エンコードしたものを
ピリオドで連結したものです。

これを署名アルゴリズムで署名し Base64Url エンコードしたものが
JWT の 3 番目の部分になります。

## 署名アルゴリズムについて

JWS では、データの **整合性保護** のために署名を使用します。
署名の方式には大きく分けて 2 種類あります。

### MAC（Message Authentication Code）：対称鍵方式

**MAC** は、JWT 作成者と検証者が **同じ鍵を共有** する方式です。

- JWT 作成者と検証者が同じ秘密鍵を持っている必要がある
- 基本的に **JWT 作成者と検証者が同じである場合** に利用

### デジタル署名：非対称鍵方式

**デジタル署名** は、**秘密鍵で署名し、公開鍵で検証** する方式です。

- JWT 作成者（秘密鍵保持）と検証者（公開鍵保持）が **異なっていてもよい**
- OIDC のような、OP が発行し RP が検証するケースに適している

### 代表的なアルゴリズム

| アルゴリズム | 名称                            | 方式     |
| ------------ | ------------------------------- | -------- |
| HS256        | HMAC using SHA-256              | 対称鍵   |
| RS256        | RSASSA-PKCS1-v1_5 using SHA-256 | 非対称鍵 |
| ES256        | ECDSA using P-256 and SHA-256   | 非対称鍵 |

次章で詳しく解説しますが、
OIDC の ID トークンでは**RS256**（RSA 署名）が推奨されており、
デフォルト値、またサポートが必須となっています。
これは、OpenID Provider が秘密鍵で署名し、
Relying Party が公開鍵で検証するという、異なる主体間でのやり取りに適しているためです。

### アルゴリズムの選択指針

アルゴリズムの選択の指針を簡単にまとめると、以下の通りです。

| ユースケース                     | 推奨アルゴリズム |
| -------------------------------- | ---------------- |
| 同一システム内での利用           | HS256            |
| 異なるシステム間での利用（OIDC） | RS256, ES256     |

また、アプリの実装者は受け入れるアルゴリズムを制限することが重要です。

## まとめ

- **JWS 形式の JWT は整合性保護の仕組みを提供する**
- **3 つの部分（ヘッダ、ペイロード、署名）で構成される**
  - 各部分は Base64Url エンコードされ、ピリオドで連結
- **ヘッダ部分**
  - 署名アルゴリズムなどのメタデータを含む
  - `alg` パラメータが必須
- **ペイロード部分**
  - JWT Claims Set として任意のデータを含む
  - 登録済みクレームが定義されている
- **署名部分**
  - ヘッダとペイロードを連結したデータに対する署名
- **署名アルゴリズムには対称鍵方式と非対称鍵方式がある**
  - OIDC では非対称鍵方式（RS256）が推奨
