# OpenID Connect/ 応用編構想

## 21. OIDC と 必要な概念

- 概要
  - OIDC の立ち位置と、OIDC に必要な概念の整理を行うことを説明
- OAuth 2.0 と OIDC の関係性 (復習)
  - OIDC は OAuth の上に載るアイデンティティ層
  - 目的は違えど、技術的には繋がっていることを説明
  - もちろん攻撃手法も被りが多いことを説明
- ID トークンの解説
  - ID トークンとは
    - ユーザのプロフィール情報を含む署名付きトークン
  - OIDC では、リソースのアクセスではなく
    - ID トークンを RP が"検証して"
    - 検証に成功 → ユーザを認証する
    - ユーザ認証が目的である点を強調
  - この ID トークン に JWT 仕様が使われている点を説明
    - JWT 仕様と ID トークン仕様は後述
  - アクセストークンと ID トークンの意図の違い
    - アクセストークン
      - 目的 → リソースへのアクセス、認可
      - 現実の概念 → 鍵
        - 漏洩すると危険なもの
      - 検証の主体 → リソースサーバ
      - 運用 → クライアントが保持し続ける
      - 必要に応じてリフレッシュ
    - ID トークン
      - 目的 → ユーザ認証
      - 現実の概念 → 証明書
        - 漏洩しても比較的安全なもの
        - インプリシットフローも許容され得る
          - 応用編で詳述
          - (とはいえセキュリティにも懸念があるので推奨はされない)
      - 検証の主体 →Relying Party(RP)
      - 運用 → 検証してセッションを開始したら破棄してよい
      - セッションを開始するための検証材料
- まとめ
  - OIDC は OAuth 2.0 の上に載る仕様
  - OIDC の目的はユーザ認証
  - ID トークンは JWT 仕様に基づく署名付きトークン
  - ID トークンを検証してユーザを認証する
  - アクセストークンとは検証の主体や運用が異なる

## 22. OIDC の登場人物とフロー

- 概要
  - OIDC に登場する主要なロールについて解説することを説明
  - OAuth 2.0 のロールとの対応関係についても解説することを説明
- OIDC の主要なロール
  - リソースオーナー -> エンドユーザ
  - クライアント -> Relying Party(RP)
    - OAuth のクライアントと同じなので、
    - Confidential/Public Client の区別も同じ
  - 認可サーバ -> OpenID Provider(OP)
  - リソースサーバ -> UserInfo Endpoint を提供するサーバ
    - つまり UserInfo Endpoint = 認可される対象のリソース
    - UserInfo Endpoint は
    - OIDC 仕様の中ではあるが
    - リソースとして認可の対象であることを強調
    - 多くの場合、OpenID Provider と同じサーバが提供する
    - ID トークンで十分な場合はあまり利用されない傾向にある
- OIDC 内に存在する認証らしさと認可らしさ
  - ID トークン ⇒ OIDC で追加された認証の仕組みが強い
  - /userinfo ⇒ OAuth 2.0 の特性を引き継いだ認可の仕組みが強い
- 認可コードフロー
  - OAuth 2.0 の認可コードフローとほぼ同じ
  - 違いは以下の通り
    - 認可リクエストのスコープに
      - `scope=openid` を含める
    - トークンレスポンスに ID トークンが含まれる
    - アクセストークンで UserInfo Endpoint にアクセスできる
  - (Section 05 を参考にして簡単なフローを記述)
- まとめ
  - OIDC の主要なロールは OAuth 2.0 とほぼ同じ
  - 認可コードフローも OAuth 2.0 とほぼ同じ
  - 違いは scope と ID トークンの追加

## 23. JWT と JWS/JWE の概要

- 概要
  - ID トークンの構造理解のために
  - まずは JWT について解説することを説明
  - JWT の関連仕様、JWS/JWE についても解説することを説明
- JWT 自体の仕様
  - JWT = Json Web Token
  - データを JSON 形式で表現し、
  - 署名や暗号化で保護しコンパクトに表現する仕様
- 皆さんが一般的にみる形
  - 一般的に JWT といわれて思い浮かべる形
    - 3 つの部分がピリオド(.)で連結された形
      - `xxxxx.yyyyy.zzzzz`
    - Base64Url エンコードされた部分が連結されている
  - これは JWS Compact Serialization 形 の JWT
  - もっと厳密に JWT の定義を理解するために
    - まずは JWS/JWE の概要を説明
- JWT に関連する仕様、JWS/JWE とは
  - JWS = Json Web Signature
    - データに対して改ざん検知の仕組みを提供する仕様
    - 一般的に JWT といわれてよく見かけるのはこちら
  - JWE = Json Web Encryption
    - データに対して暗号化を行い
    - 機密性を提供する仕様
  - JWS/JWE はそれぞれ
    - データを含める部分が存在する
      - JWS: ペイロード部分
      - JWE: プレインテキスト部分
        - そのまま含まれる訳ではなく、
        - JWE 生成時に暗号化され、暗号文として含まれる
  - JWS/JWE にはシリアライズ(表現方法)が複数ある
    - Compact Serialization
      - URL に載せやすいコンパクトな表現
    - JSON Serialization
      - JSON 形式で柔軟に表現できる
- JWT の厳密な定義
  - JWT は、データが内部に含まれた
  - Compact Serialization 形 の
  - JWS か JWE であると定義されている
  - JWT = JWS Compact もしくは JWE Compact
  - この内、一般的に JWT といわれて思い浮かべる形は
  - JWS Compact 形 の JWT であることが多い
  - 包含関係が複雑なので注意
- 今回の解説では
  - OIDC の ID トークンに必要な JWT の仕様のみを解説
  - JWS/JWE など
  - JWT 関連の詳しい仕様は
  - 後ほど応用編で解説することを説明
  - ご了承いただけると幸い
- まとめ
  - JWT は JWS か JWE である
  - JWS/JWE はデータを含める仕組みを提供する
  - JWS は改ざん検知
  - JWE は暗号化
  - JWT は Compact Serialization 形 の JWS/JWE

## 24. JWT (JWS 形式) の詳しい構造

- 概要
  - 前章で説明した
  - JWS 形式(厳密には JWS Compact Serialization 形式)の
  - JWT の詳しい構造について解説することを説明
- JWS 形式 JWT の構造
  - ペイロード部分に任意の JSON データを含められる
- 構成要素
  - ヘッダ部分、ペイロード部分、署名部分
    - それぞれの部分が Base64Url エンコードされ、
    - ピリオド(.)で連結される
    - `Base64Url(ヘッダ) . Base64Url(ペイロード) . Base64Url(署名)`
  - ヘッダ部分
    - JOSE Header と呼ばれる
    - 署名アルゴリズムなどのメタデータを含む
    - JSON 形式で表現される
    - 必須のパラメータ
      - `alg`: 署名アルゴリズム
    - JSON を Base64Url エンコードしたものが
      - ヘッダ部分として含まれる
  - ペイロード部分
    - 任意のデータを含める部分
    - JWT ではペイロードに JSON 形式のデータを含められる
      - JSON 形式のデータ = JSON Claim Set と呼ばれる
    - JWT の場合、予約済み
      - = ある特定の意図を持って利用する必要のある
      - パラメータは存在する
    - OIDC ID トークン固有のパラメータについては
      - また後ほど解説
    - こちらも JSON を Base64Url エンコードしたものが
      - ペイロード部分として含まれる
  - 署名部分
    - 生成した署名や MAC を含む部分
    - 署名の値の計算は以下の通り
      - 署名対象データ = `Base64Url(ヘッダ) . Base64Url(ペイロード)`
      - これに対する署名を Base64Url エンコードしたものが
      - 署名部分として含まれる
- 署名の詳しいアルゴリズムについて
  - 改ざん検知の仕組みは以下の通り
  - MAC: 対称鍵方式
    - JWT 作成者と検証者が同じ鍵を持っている必要がある
    - → 基本的に JWT 作成者と検証者が同じである場合に利用
  - デジタル署名: 非対称鍵方式
    - JWT 作成者と検証者が異なる場合でもよい
  - 代表的なアルゴリズム
    - HMAC using SHA-256 (HS256)
      - 対称鍵方式
    - RSASSA-PKCS1-v1_5 using SHA-256 (RS256)
      - 非対称鍵方式
    - ECDSA using P-256 and SHA-256 (ES256)
      - 非対称鍵方式
- まとめ
  - JWS 形式 JWT は改ざん検知の仕組みを提供する
  - ヘッダ、ペイロード、署名の 3 部分で構成される
  - 署名アルゴリズムには対称鍵暗号方式と非対称鍵暗号方式がある

## 25. ID トークンの 仕様

- 概要
  - OIDC の ID トークンの仕様について解説することを説明
  - JWT/JWS の知識が前提となることを説明
- ID トークンの構造
  - 基本的に JWT (JWS 形式) で提供
  - アルゴリズムは RS256 推奨
    - `none`は原則禁止
    - HS256 も避けるべき
      - Confidential Client で
      - クライアント認証が出来る場合のみ許容
- ヘッダ部分
  - JWT (JWS 形式) のヘッダ部分と同様
  - `alg` パラメータ
    - アルゴリズムの指定
    - 前述の通り RS256 推奨
    - 必須
  - `typ` パラメータ
    - 種類を示すために使う
    - 値は `"JWT"` とすることが推奨
    - 任意
  - `kid` パラメータ
    - 署名検証に使う鍵を識別するために使う
    - 複数の鍵のリストから選択する場合に有用
    - ヒントなので任意
    - 詳細は 応用編 JWK/JWK Set で解説
- ペイロード部分
  - JWT (JWS 形式) のペイロード部分と同様
  - JSON Claim Set 形式のデータを含む
  - OIDC ID トークン 固有のパラメータ
    - 必須なもの
      - `iss`: 発行者
        - Issuer Identifier
        - OpenID Provider(OP) に一意な識別子
      - `sub`: ユーザ識別子
        - ログインするユーザを一意に識別するための識別子
        - OP 内で一意
      - `aud`: クライアント識別子
        - ID トークンにおいては
        - クライアント = Relying Party(RP)の ID
      - `exp`: 有効期限
        - この期限を過ぎたら無効
      - `iat`: 発行時刻
    - それ以外のパラメータは
    - 純粋な認可コードフローにおいては任意
      - 応用編でまた解説
- 署名部分
  - JWT (JWS 形式) の署名部分と同様
  - 特に変更点はない
- まとめ
  - ID トークンは JWT (JWS 形式) で提供される
  - JWT/JWS の知識が前提
  - ヘッダの変更点はあまりないが
    - alg: none の禁止
    - HS256 の原則禁止
    - typ: JWT 推奨
  - ペイロードの変更点は
    - OIDC 固有のパラメータが追加されている点
    - 必須パラメータがある点
  - 署名部分の変更点はない

## 26. OIDC 完全版 コードフロー解説

- 概要
  - OIDC の完全版コードフローについて解説することを説明
  - 前章までの知識が前提となることを説明
- フローの全体像
  - (Section 13, Section 18 を参考にして詳しいフローを記述)
- まとめ
  - OIDC の完全版コードフローについて解説した
